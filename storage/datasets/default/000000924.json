{
	"title": "Vectara | ü¶úÔ∏èüîó Langchain",
	"url": "https://python.langchain.com/docs/integrations/vectorstores/vectara",
	"html": "ComponentsVector storesVectara\nVectara\n\nVectara is a API platform for building GenAI applications. It provides an easy-to-use API for document indexing and querying that is managed by Vectara and is optimized for performance and accuracy. See the Vectara API documentation for more information on how to use the API.\n\nThis notebook shows how to use functionality related to the Vectara's integration with langchain. Note that unlike many other integrations in this category, Vectara provides an end-to-end managed service for Grounded Generation (aka retrieval augmented generation), which includes:\n\nA way to extract text from document files and chunk them into sentences.\nIts own embeddings model and vector store - each text segment is encoded into a vector embedding and stored in the Vectara internal vector store\nA query service that automatically encodes the query into embedding, and retrieves the most relevant text segments (including support for Hybrid Search)\n\nAll of these are supported in this LangChain integration.\n\nSetup\n\nYou will need a Vectara account to use Vectara with LangChain. To get started, use the following steps (see our quickstart guide):\n\nSign up for a Vectara account if you don't already have one. Once you have completed your sign up you will have a Vectara customer ID. You can find your customer ID by clicking on your name, on the top-right of the Vectara console window.\nWithin your account you can create one or more corpora. Each corpus represents an area that stores text data upon ingest from input documents. To create a corpus, use the \"Create Corpus\" button. You then provide a name to your corpus as well as a description. Optionally you can define filtering attributes and apply some advanced options. If you click on your created corpus, you can see its name and corpus ID right on the top.\nNext you'll need to create API keys to access the corpus. Click on the \"Authorization\" tab in the corpus view and then the \"Create API Key\" button. Give your key a name, and choose whether you want query only or query+index for your key. Click \"Create\" and you now have an active API key. Keep this key confidential.\n\nTo use LangChain with Vectara, you'll need to have these three values: customer ID, corpus ID and api_key. You can provide those to LangChain in two ways:\n\nInclude in your environment these three variables: VECTARA_CUSTOMER_ID, VECTARA_CORPUS_ID and VECTARA_API_KEY.\n\nFor example, you can set these variables using os.environ and getpass as follows:\n\nimport os\nimport getpass\n\nos.environ[\"VECTARA_CUSTOMER_ID\"] = getpass.getpass(\"Vectara Customer ID:\")\nos.environ[\"VECTARA_CORPUS_ID\"] = getpass.getpass(\"Vectara Corpus ID:\")\nos.environ[\"VECTARA_API_KEY\"] = getpass.getpass(\"Vectara API Key:\")\n\nProvide them as arguments when creating the Vectara vectorstore object:\nvectorstore = Vectara(\n                vectara_customer_id=vectara_customer_id,\n                vectara_corpus_id=vectara_corpus_id,\n                vectara_api_key=vectara_api_key\n            )\n\nConnecting to Vectara from LangChain‚Äã\n\nIn this example, we assume that you've created an account and a corpus, and added your VECTARA_CUSTOMER_ID, VECTARA_CORPUS_ID and VECTARA_API_KEY (created with permissions for both indexing and query) as environment variables.\n\nThe corpus has 3 fields defined as metadata for filtering:\n\nurl: a string field containing the source URL of the document (where relevant)\nspeech: a string field containing the name of the speech\nauthor: the name of the author\n\nLet's start by ingesting 3 documents into the corpus:\n\nThe State of the Union speech from 2022, available in the LangChain repository as a text file\nThe \"I have a dream\" speech by Dr. Kind\nThe \"We shall Fight on the Beaches\" speech by Winston Churchil\nfrom langchain.chains.query_constructor.base import AttributeInfo\nfrom langchain.document_loaders import TextLoader\nfrom langchain.embeddings import FakeEmbeddings\nfrom langchain.llms import OpenAI\nfrom langchain.retrievers.self_query.base import SelfQueryRetriever\nfrom langchain.text_splitter import CharacterTextSplitter\nfrom langchain.vectorstores import Vectara\n\nloader = TextLoader(\"../../modules/state_of_the_union.txt\")\ndocuments = loader.load()\ntext_splitter = CharacterTextSplitter(chunk_size=1000, chunk_overlap=0)\ndocs = text_splitter.split_documents(documents)\n\nvectara = Vectara.from_documents(\n    docs,\n    embedding=FakeEmbeddings(size=768),\n    doc_metadata={\"speech\": \"state-of-the-union\", \"author\": \"Biden\"},\n)\n\n\nVectara's indexing API provides a file upload API where the file is handled directly by Vectara - pre-processed, chunked optimally and added to the Vectara vector store. To use this, we added the add_files() method (as well as from_files()).\n\nLet's see this in action. We pick two PDF documents to upload:\n\nThe \"I have a dream\" speech by Dr. King\nChurchill's \"We Shall Fight on the Beaches\" speech\nimport tempfile\nimport urllib.request\n\nurls = [\n    [\n        \"https://www.gilderlehrman.org/sites/default/files/inline-pdfs/king.dreamspeech.excerpts.pdf\",\n        \"I-have-a-dream\",\n        \"Dr. King\",\n    ],\n    [\n        \"https://www.parkwayschools.net/cms/lib/MO01931486/Centricity/Domain/1578/Churchill_Beaches_Speech.pdf\",\n        \"we shall fight on the beaches\",\n        \"Churchil\",\n    ],\n]\nfiles_list = []\nfor url, _, _ in urls:\n    name = tempfile.NamedTemporaryFile().name\n    urllib.request.urlretrieve(url, name)\n    files_list.append(name)\n\ndocsearch: Vectara = Vectara.from_files(\n    files=files_list,\n    embedding=FakeEmbeddings(size=768),\n    metadatas=[\n        {\"url\": url, \"speech\": title, \"author\": author} for url, title, author in urls\n    ],\n)\n\nSimilarity search‚Äã\n\nThe simplest scenario for using Vectara is to perform a similarity search.\n\nquery = \"What did the president say about Ketanji Brown Jackson\"\nfound_docs = vectara.similarity_search(\n    query, n_sentence_context=0, filter=\"doc.speech = 'state-of-the-union'\"\n)\n\nprint(found_docs[0].page_content)\n\n    And I did that 4 days ago, when I nominated Circuit Court of Appeals Judge Ketanji Brown Jackson.\n\nSimilarity search with score‚Äã\n\nSometimes we might want to perform the search, but also obtain a relevancy score to know how good is a particular result.\n\nquery = \"What did the president say about Ketanji Brown Jackson\"\nfound_docs = vectara.similarity_search_with_score(\n    query,\n    filter=\"doc.speech = 'state-of-the-union'\",\n    score_threshold=0.2,\n)\n\ndocument, score = found_docs[0]\nprint(document.page_content)\nprint(f\"\\nScore: {score}\")\n\n    Justice Breyer, thank you for your service. One of the most serious constitutional responsibilities a President has is nominating someone to serve on the United States Supreme Court. And I did that 4 days ago, when I nominated Circuit Court of Appeals Judge Ketanji Brown Jackson. One of our nation‚Äôs top legal minds, who will continue Justice Breyer‚Äôs legacy of excellence. A former top litigator in private practice.\n    \n    Score: 0.8299499\n\n\nNow let's do similar search for content in the files we uploaded\n\nquery = \"We must forever conduct our struggle\"\nmin_score = 1.2\nfound_docs = vectara.similarity_search_with_score(\n    query,\n    filter=\"doc.speech = 'I-have-a-dream'\",\n    score_threshold=min_score,\n)\nprint(f\"With this threshold of {min_score} we have {len(found_docs)} documents\")\n\n    With this threshold of 1.2 we have 0 documents\n\nquery = \"We must forever conduct our struggle\"\nmin_score = 0.2\nfound_docs = vectara.similarity_search_with_score(\n    query,\n    filter=\"doc.speech = 'I-have-a-dream'\",\n    score_threshold=min_score,\n)\nprint(f\"With this threshold of {min_score} we have {len(found_docs)} documents\")\n\n    With this threshold of 0.2 we have 5 documents\n\nVectara as a Retriever‚Äã\n\nVectara, as all the other LangChain vectorstores, is most often used as a LangChain Retriever:\n\nretriever = vectara.as_retriever()\nretriever\n\n    VectaraRetriever(tags=['Vectara'], metadata=None, vectorstore=<langchain.vectorstores.vectara.Vectara object at 0x13b15e9b0>, search_type='similarity', search_kwargs={'lambda_val': 0.025, 'k': 5, 'filter': '', 'n_sentence_context': '2'})\n\nquery = \"What did the president say about Ketanji Brown Jackson\"\nretriever.get_relevant_documents(query)[0]\n\n    Document(page_content='Justice Breyer, thank you for your service. One of the most serious constitutional responsibilities a President has is nominating someone to serve on the United States Supreme Court. And I did that 4 days ago, when I nominated Circuit Court of Appeals Judge Ketanji Brown Jackson. One of our nation‚Äôs top legal minds, who will continue Justice Breyer‚Äôs legacy of excellence. A former top litigator in private practice.', metadata={'source': 'langchain', 'lang': 'eng', 'offset': '596', 'len': '97', 'speech': 'state-of-the-union', 'author': 'Biden'})\n\nUsing Vectara as a SelfQuery Retriever‚Äã\nmetadata_field_info = [\n    AttributeInfo(\n        name=\"speech\",\n        description=\"what name of the speech\",\n        type=\"string or list[string]\",\n    ),\n    AttributeInfo(\n        name=\"author\",\n        description=\"author of the speech\",\n        type=\"string or list[string]\",\n    ),\n]\ndocument_content_description = \"the text of the speech\"\n\nvectordb = Vectara()\nllm = OpenAI(temperature=0)\nretriever = SelfQueryRetriever.from_llm(\n    llm, vectara, document_content_description, metadata_field_info, verbose=True\n)\n\nretriever.get_relevant_documents(\"what did Biden say about the freedom?\")\n\n    /Users/ofer/dev/langchain/libs/langchain/langchain/chains/llm.py:278: UserWarning: The predict_and_parse method is deprecated, instead pass an output parser directly to LLMChain.\n      warnings.warn(\n\n\n    query='freedom' filter=Comparison(comparator=<Comparator.EQ: 'eq'>, attribute='author', value='Biden') limit=None\n\n\n\n\n\n    [Document(page_content='Well I know this nation. We will meet the test. To protect freedom and liberty, to expand fairness and opportunity. We will save democracy. As hard as these times have been, I am more optimistic about America today than I have been my whole life.', metadata={'source': 'langchain', 'lang': 'eng', 'offset': '346', 'len': '67', 'speech': 'state-of-the-union', 'author': 'Biden'}),\n     Document(page_content='To our fellow Ukrainian Americans who forge a deep bond that connects our two nations we stand with you. Putin may circle Kyiv with tanks, but he will never gain the hearts and souls of the Ukrainian people. He will never extinguish their love of freedom. He will never weaken the resolve of the free world. We meet tonight in an America that has lived through two of the hardest years this nation has ever faced.', metadata={'source': 'langchain', 'lang': 'eng', 'offset': '740', 'len': '47', 'speech': 'state-of-the-union', 'author': 'Biden'}),\n     Document(page_content='But most importantly as Americans. With a duty to one another to the American people to the Constitution. And with an unwavering resolve that freedom will always triumph over tyranny. Six days ago, Russia‚Äôs Vladimir Putin sought to shake the foundations of the free world thinking he could make it bend to his menacing ways. But he badly miscalculated.', metadata={'source': 'langchain', 'lang': 'eng', 'offset': '413', 'len': '77', 'speech': 'state-of-the-union', 'author': 'Biden'}),\n     Document(page_content='We can do this. \\n\\nMy fellow Americans‚Äîtonight , we have gathered in a sacred space‚Äîthe citadel of our democracy. In this Capitol, generation after generation, Americans have debated great questions amid great strife, and have done great things. We have fought for freedom, expanded liberty, defeated totalitarianism and terror. And built the strongest, freest, and most prosperous nation the world has ever known. Now is the hour. \\n\\nOur moment of responsibility.', metadata={'source': 'langchain', 'lang': 'eng', 'offset': '906', 'len': '82', 'speech': 'state-of-the-union', 'author': 'Biden'}),\n     Document(page_content='In state after state, new laws have been passed, not only to suppress the vote, but to subvert entire elections. We cannot let this happen. Tonight. I call on the Senate to: Pass the Freedom to Vote Act. Pass the John Lewis Voting Rights Act. And while you‚Äôre at it, pass the Disclose Act so Americans can know who is funding our elections.', metadata={'source': 'langchain', 'lang': 'eng', 'offset': '0', 'len': '63', 'speech': 'state-of-the-union', 'author': 'Biden'})]\n\nretriever.get_relevant_documents(\"what did Dr. King say about the freedom?\")\n\n    query='freedom' filter=Comparison(comparator=<Comparator.EQ: 'eq'>, attribute='author', value='Dr. King') limit=None\n\n\n\n\n\n    [Document(page_content='And if America is to be a great nation, this must become true. So\\nlet freedom ring from the prodigious hilltops of New Hampshire. Let freedom ring from the mighty\\nmountains of New York. Let freedom ring from the heightening Alleghenies of Pennsylvania. Let\\nfreedom ring from the snowcapped Rockies of Colorado.', metadata={'lang': 'eng', 'section': '3', 'offset': '1534', 'len': '55', 'CreationDate': '1424880481', 'Producer': 'Adobe PDF Library 10.0', 'Author': 'Sasha Rolon-Pereira', 'Title': 'Martin Luther King Jr.pdf', 'Creator': 'Acrobat PDFMaker 10.1 for Word', 'ModDate': '1424880524', 'url': 'https://www.gilderlehrman.org/sites/default/files/inline-pdfs/king.dreamspeech.excerpts.pdf', 'speech': 'I-have-a-dream', 'author': 'Dr. King', 'title': 'Martin Luther King Jr.pdf'}),\n     Document(page_content='And if America is to be a great nation, this must become true. So\\nlet freedom ring from the prodigious hilltops of New Hampshire. Let freedom ring from the mighty\\nmountains of New York. Let freedom ring from the heightening Alleghenies of Pennsylvania. Let\\nfreedom ring from the snowcapped Rockies of Colorado.', metadata={'lang': 'eng', 'section': '3', 'offset': '1534', 'len': '55', 'CreationDate': '1424880481', 'Producer': 'Adobe PDF Library 10.0', 'Author': 'Sasha Rolon-Pereira', 'Title': 'Martin Luther King Jr.pdf', 'Creator': 'Acrobat PDFMaker 10.1 for Word', 'ModDate': '1424880524', 'url': 'https://www.gilderlehrman.org/sites/default/files/inline-pdfs/king.dreamspeech.excerpts.pdf', 'speech': 'I-have-a-dream', 'author': 'Dr. King', 'title': 'Martin Luther King Jr.pdf'}),\n     Document(page_content='Let freedom ring from the curvaceous slopes of\\nCalifornia. But not only that. Let freedom ring from Stone Mountain of Georgia. Let freedom ring from Lookout\\nMountain of Tennessee. Let freedom ring from every hill and molehill of Mississippi, from every\\nmountain side. Let freedom ring . . .\\nWhen we allow freedom to ring‚Äîwhen we let it ring from every city and every hamlet, from every state\\nand every city, we will be able to speed up that day when all of God‚Äôs children, black men and white\\nmen, Jews and Gentiles, Protestants and Catholics, will be able to join hands and sing in the words of the\\nold Negro spiritual, ‚ÄúFree at last, Free at last, Great God a-mighty, We are free at last.‚Äù', metadata={'lang': 'eng', 'section': '3', 'offset': '1842', 'len': '52', 'CreationDate': '1424880481', 'Producer': 'Adobe PDF Library 10.0', 'Author': 'Sasha Rolon-Pereira', 'Title': 'Martin Luther King Jr.pdf', 'Creator': 'Acrobat PDFMaker 10.1 for Word', 'ModDate': '1424880524', 'url': 'https://www.gilderlehrman.org/sites/default/files/inline-pdfs/king.dreamspeech.excerpts.pdf', 'speech': 'I-have-a-dream', 'author': 'Dr. King', 'title': 'Martin Luther King Jr.pdf'}),\n     Document(page_content='Let freedom ring from the curvaceous slopes of\\nCalifornia. But not only that. Let freedom ring from Stone Mountain of Georgia. Let freedom ring from Lookout\\nMountain of Tennessee. Let freedom ring from every hill and molehill of Mississippi, from every\\nmountain side. Let freedom ring . . .\\nWhen we allow freedom to ring‚Äîwhen we let it ring from every city and every hamlet, from every state\\nand every city, we will be able to speed up that day when all of God‚Äôs children, black men and white\\nmen, Jews and Gentiles, Protestants and Catholics, will be able to join hands and sing in the words of the\\nold Negro spiritual, ‚ÄúFree at last, Free at last, Great God a-mighty, We are free at last.‚Äù', metadata={'lang': 'eng', 'section': '3', 'offset': '1842', 'len': '52', 'CreationDate': '1424880481', 'Producer': 'Adobe PDF Library 10.0', 'Author': 'Sasha Rolon-Pereira', 'Title': 'Martin Luther King Jr.pdf', 'Creator': 'Acrobat PDFMaker 10.1 for Word', 'ModDate': '1424880524', 'url': 'https://www.gilderlehrman.org/sites/default/files/inline-pdfs/king.dreamspeech.excerpts.pdf', 'speech': 'I-have-a-dream', 'author': 'Dr. King', 'title': 'Martin Luther King Jr.pdf'}),\n     Document(page_content='Let freedom ring from the mighty\\nmountains of New York. Let freedom ring from the heightening Alleghenies of Pennsylvania. Let\\nfreedom ring from the snowcapped Rockies of Colorado. Let freedom ring from the curvaceous slopes of\\nCalifornia. But not only that. Let freedom ring from Stone Mountain of Georgia.', metadata={'lang': 'eng', 'section': '3', 'offset': '1657', 'len': '57', 'CreationDate': '1424880481', 'Producer': 'Adobe PDF Library 10.0', 'Author': 'Sasha Rolon-Pereira', 'Title': 'Martin Luther King Jr.pdf', 'Creator': 'Acrobat PDFMaker 10.1 for Word', 'ModDate': '1424880524', 'url': 'https://www.gilderlehrman.org/sites/default/files/inline-pdfs/king.dreamspeech.excerpts.pdf', 'speech': 'I-have-a-dream', 'author': 'Dr. King', 'title': 'Martin Luther King Jr.pdf'})]\n\nPrevious\nVearch\nNext\nVespa"
}