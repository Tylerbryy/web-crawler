{
	"title": "Add message history (memory) | ü¶úÔ∏èüîó Langchain",
	"url": "https://python.langchain.com/docs/expression_language/how_to/message_history",
	"html": "LangChain Expression LanguageHow toAdd message history (memory)\nAdd message history (memory)\n\nThe RunnableWithMessageHistory let's us add message history to certain types of chains.\n\nSpecifically, it can be used for any Runnable that takes as input one of\n\na sequence of BaseMessage\na dict with a key that takes a sequence of BaseMessage\na dict with a key that takes the latest message(s) as a string or sequence of BaseMessage, and a separate key that takes historical messages\n\nAnd returns as output one of\n\na string that can be treated as the contents of an AIMessage\na sequence of BaseMessage\na dict with a key that contains a sequence of BaseMessage\n\nLet's take a look at some examples to see how it works.\n\nSetup‚Äã\n\nWe'll use Redis to store our chat message histories and Anthropic's claude-2 model so we'll need to install the following dependencies:\n\npip install -U langchain redis anthropic\n\n\nSet your Anthropic API key:\n\nimport getpass\nimport os\n\nos.environ[\"ANTHROPIC_API_KEY\"] = getpass.getpass()\n\n\nStart a local Redis Stack server if we don't have an existing Redis deployment to connect to:\n\ndocker run -d -p 6379:6379 -p 8001:8001 redis/redis-stack:latest\n\nREDIS_URL = \"redis://localhost:6379/0\"\n\nLangSmith‚Äã\n\nLangSmith is especially useful for something like message history injection, where it can be hard to otherwise understand what the inputs are to various parts of the chain.\n\nNote that LangSmith is not needed, but it is helpful. If you do want to use LangSmith, after you sign up at the link above, make sure to uncoment the below and set your environment variables to start logging traces:\n\n# os.environ[\"LANGCHAIN_TRACING_V2\"] = \"true\"\n# os.environ[\"LANGCHAIN_API_KEY\"] = getpass.getpass()\n\nExample: Dict input, message output‚Äã\n\nLet's create a simple chain that takes a dict as input and returns a BaseMessage.\n\nIn this case the \"question\" key in the input represents our input message, and the \"history\" key is where our historical messages will be injected.\n\nfrom typing import Optional\n\nfrom langchain.chat_models import ChatAnthropic\nfrom langchain.memory.chat_message_histories import RedisChatMessageHistory\nfrom langchain.prompts import ChatPromptTemplate, MessagesPlaceholder\nfrom langchain.schema.chat_history import BaseChatMessageHistory\nfrom langchain.schema.runnable.history import RunnableWithMessageHistory\n\nprompt = ChatPromptTemplate.from_messages(\n    [\n        (\"system\", \"You're an assistant who's good at {ability}\"),\n        MessagesPlaceholder(variable_name=\"history\"),\n        (\"human\", \"{question}\"),\n    ]\n)\n\nchain = prompt | ChatAnthropic(model=\"claude-2\")\n\nAdding message history‚Äã\n\nTo add message history to our original chain we wrap it in the RunnableWithMessageHistory class.\n\nCrucially, we also need to define a method that takes a session_id string and based on it returns a BaseChatMessageHistory. Given the same input, this method should return an equivalent output.\n\nIn this case we'll also want to specify input_messages_key (the key to be treated as the latest input message) and history_messages_key (the key to add historical messages to).\n\nchain_with_history = RunnableWithMessageHistory(\n    chain,\n    lambda session_id: RedisChatMessageHistory(session_id, url=REDIS_URL),\n    input_messages_key=\"question\",\n    history_messages_key=\"history\",\n)\n\nInvoking with config‚Äã\n\nWhenever we call our chain with message history, we need to include a config that contains the session_id\n\nconfig={\"configurable\": {\"session_id\": \"<SESSION_ID>\"}}\n\n\nGiven the same configuration, our chain should be pulling from the same chat message history.\n\nchain_with_history.invoke(\n    {\"ability\": \"math\", \"question\": \"What does cosine mean?\"},\n    config={\"configurable\": {\"session_id\": \"foobar\"}},\n)\n\n    AIMessage(content=' Cosine is one of the basic trigonometric functions in mathematics. It is defined as the ratio of the adjacent side to the hypotenuse in a right triangle.\\n\\nSome key properties and facts about cosine:\\n\\n- It is denoted by cos(Œ∏), where Œ∏ is the angle in a right triangle. \\n\\n- The cosine of an acute angle is always positive. For angles greater than 90 degrees, cosine can be negative.\\n\\n- Cosine is one of the three main trig functions along with sine and tangent.\\n\\n- The cosine of 0 degrees is 1. As the angle increases towards 90 degrees, the cosine value decreases towards 0.\\n\\n- The range of values for cosine is -1 to 1.\\n\\n- The cosine function maps angles in a circle to the x-coordinate on the unit circle.\\n\\n- Cosine is used to find adjacent side lengths in right triangles, and has many other applications in mathematics, physics, engineering and more.\\n\\n- Key cosine identities include: cos(A+B) = cosAcosB ‚àí sinAsinB and cos(2A) = cos^2(A) ‚àí sin^2(A)\\n\\nSo in summary, cosine is a fundamental trig')\n\nchain_with_history.invoke(\n    {\"ability\": \"math\", \"question\": \"What's its inverse\"},\n    config={\"configurable\": {\"session_id\": \"foobar\"}},\n)\n\n    AIMessage(content=' The inverse of the cosine function is called the arccosine or inverse cosine, often denoted as cos-1(x) or arccos(x).\\n\\nThe key properties and facts about arccosine:\\n\\n- It is defined as the angle Œ∏ between 0 and œÄ radians whose cosine is x. So arccos(x) = Œ∏ such that cos(Œ∏) = x.\\n\\n- The range of arccosine is 0 to œÄ radians (0 to 180 degrees).\\n\\n- The domain of arccosine is -1 to 1. \\n\\n- arccos(cos(Œ∏)) = Œ∏ for values of Œ∏ from 0 to œÄ radians.\\n\\n- arccos(x) is the angle in a right triangle whose adjacent side is x and hypotenuse is 1.\\n\\n- arccos(0) = 90 degrees. As x increases from 0 to 1, arccos(x) decreases from 90 to 0 degrees.\\n\\n- arccos(1) = 0 degrees. arccos(-1) = 180 degrees.\\n\\n- The graph of y = arccos(x) is part of the unit circle, restricted to x')\n\nLANGSMITH TRACE\n\nLooking at the Langsmith trace for the second call, we can see that when constructing the prompt, a \"history\" variable has been injected which is a list of two messages (our first input and first output).\n\nExample: messages input, dict output‚Äã\nfrom langchain.schema.messages import HumanMessage\nfrom langchain.schema.runnable import RunnableMap\n\nchain = RunnableMap({\"output_message\": ChatAnthropic(model=\"claude-2\")})\nchain_with_history = RunnableWithMessageHistory(\n    chain,\n    lambda session_id: RedisChatMessageHistory(session_id, url=REDIS_URL),\n    output_messages_key=\"output_message\",\n)\n\nchain_with_history.invoke(\n    [HumanMessage(content=\"What did Simone de Beauvoir believe about free will\")],\n    config={\"configurable\": {\"session_id\": \"baz\"}},\n)\n\n    {'output_message': AIMessage(content=' Here is a summary of Simone de Beauvoir\\'s views on free will:\\n\\n- De Beauvoir was an existentialist philosopher and believed strongly in the concept of free will. She rejected the idea that human nature or instincts determine behavior.\\n\\n- Instead, de Beauvoir argued that human beings define their own essence or nature through their actions and choices. As she famously wrote, \"One is not born, but rather becomes, a woman.\"\\n\\n- De Beauvoir believed that while individuals are situated in certain cultural contexts and social conditions, they still have agency and the ability to transcend these situations. Freedom comes from choosing one\\'s attitude toward these constraints.\\n\\n- She emphasized the radical freedom and responsibility of the individual. We are \"condemned to be free\" because we cannot escape making choices and taking responsibility for our choices. \\n\\n- De Beauvoir felt that many people evade their freedom and responsibility by adopting rigid mindsets, ideologies, or conforming uncritically to social roles.\\n\\n- She advocated for the recognition of ambiguity in the human condition and warned against the quest for absolute rules that deny freedom and responsibility. Authentic living involves embracing ambiguity.\\n\\nIn summary, de Beauvoir promoted an existential ethics')}\n\nchain_with_history.invoke(\n    [HumanMessage(content=\"How did this compare to Sartre\")],\n    config={\"configurable\": {\"session_id\": \"baz\"}},\n)\n\n    {'output_message': AIMessage(content=\" There are many similarities between Simone de Beauvoir's views on free will and those of Jean-Paul Sartre, though some key differences emerge as well:\\n\\nSimilarities with Sartre:\\n\\n- Both were existentialist thinkers who rejected determinism and emphasized human freedom and responsibility.\\n\\n- They agreed that existence precedes essence - there is no predefined human nature that determines who we are.\\n\\n- Individuals must define themselves through their choices and actions. This leads to anxiety but also freedom.\\n\\n- The human condition is characterized by ambiguity and uncertainty, rather than fixed meanings/values.\\n\\n- Both felt that most people evade their freedom through self-deception, conformity, or adopting collective identities/values uncritically.\\n\\nDifferences from Sartre: \\n\\n- Sartre placed more emphasis on the burden and anguish of radical freedom. De Beauvoir focused more on its positive potential.\\n\\n- De Beauvoir critiqued Sartre's premise that human relations are necessarily conflictual. She saw more potential for mutual recognition.\\n\\n- Sartre saw the Other's gaze as a threat to freedom. De Beauvoir put more stress on how the Other's gaze can confirm\")}\n\nLANGSMITH TRACE\nMore examples‚Äã\n\nWe could also do any of the below:\n\nfrom operator import itemgetter\n\n# messages in, messages out\nRunnableWithMessageHistory(\n    ChatAnthropic(model=\"claude-2\"),\n    lambda session_id: RedisChatMessageHistory(session_id, url=REDIS_URL),\n)\n\n# dict with single key for all messages in, messages out\nRunnableWithMessageHistory(\n    itemgetter(\"input_messages\") | ChatAnthropic(model=\"claude-2\"),\n    lambda session_id: RedisChatMessageHistory(session_id, url=REDIS_URL),\n    input_messages_key=\"input_messages\",\n)\n\nPrevious\nParallelize steps\nNext\nDynamically route logic based on input"
}