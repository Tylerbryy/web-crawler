{
	"title": "RAG with Agents | 🦜️🔗 Langchain",
	"url": "https://python.langchain.com/docs/use_cases/question_answering/conversational_retrieval_agents",
	"html": "Retrieval-augmented generation (RAG)RAG with Agents\nRAG with Agents\n\nThis is an agent specifically optimized for doing retrieval when necessary and also holding a conversation.\n\nTo start, we will set up the retriever we want to use, and then turn it into a retriever tool. Next, we will use the high level constructor for this type of agent. Finally, we will walk through how to construct a conversational retrieval agent from components.\n\nThe Retriever​\n\nTo start, we need a retriever to use! The code here is mostly just example code. Feel free to use your own retriever and skip to the section on creating a retriever tool.\n\nfrom langchain.document_loaders import TextLoader\n\nloader = TextLoader(\"../../../../../docs/docs/modules/state_of_the_union.txt\")\n\nfrom langchain.embeddings import OpenAIEmbeddings\nfrom langchain.text_splitter import CharacterTextSplitter\nfrom langchain.vectorstores import FAISS\n\ndocuments = loader.load()\ntext_splitter = CharacterTextSplitter(chunk_size=1000, chunk_overlap=0)\ntexts = text_splitter.split_documents(documents)\nembeddings = OpenAIEmbeddings()\ndb = FAISS.from_documents(texts, embeddings)\n\nretriever = db.as_retriever()\n\nRetriever Tool​\n\nNow we need to create a tool for our retriever. The main things we need to pass in are a name for the retriever as well as a description. These will both be used by the language model, so they should be informative.\n\nfrom langchain.agents.agent_toolkits import create_retriever_tool\n\ntool = create_retriever_tool(\n    retriever,\n    \"search_state_of_union\",\n    \"Searches and returns documents regarding the state-of-the-union.\",\n)\ntools = [tool]\n\nAgent Constructor​\n\nHere, we will use the high level create_conversational_retrieval_agent API to construct the agent.\n\nNotice that beside the list of tools, the only thing we need to pass in is a language model to use. Under the hood, this agent is using the OpenAIFunctionsAgent, so we need to use an ChatOpenAI model.\n\nfrom langchain.agents.agent_toolkits import create_conversational_retrieval_agent\n\nfrom langchain.chat_models import ChatOpenAI\n\nllm = ChatOpenAI(temperature=0)\n\nagent_executor = create_conversational_retrieval_agent(llm, tools, verbose=True)\n\n\nWe can now try it out!\n\nresult = agent_executor({\"input\": \"hi, im bob\"})\n\n    \n    \n    > Entering new AgentExecutor chain...\n    Hello Bob! How can I assist you today?\n    \n    > Finished chain.\n\nresult[\"output\"]\n\n    'Hello Bob! How can I assist you today?'\n\n\nNotice that it remembers your name\n\nresult = agent_executor({\"input\": \"whats my name?\"})\n\n    \n    \n    > Entering new AgentExecutor chain...\n    Your name is Bob.\n    \n    > Finished chain.\n\nresult[\"output\"]\n\n    'Your name is Bob.'\n\n\nNotice that it now does retrieval\n\nresult = agent_executor(\n    {\n        \"input\": \"what did the president say about kentaji brown jackson in the most recent state of the union?\"\n    }\n)\n\n    \n    \n    > Entering new AgentExecutor chain...\n    \n    Invoking: `search_state_of_union` with `{'query': 'Kentaji Brown Jackson'}`\n    \n    \n    [Document(page_content='Tonight. I call on the Senate to: Pass the Freedom to Vote Act. Pass the John Lewis Voting Rights Act. And while you’re at it, pass the Disclose Act so Americans can know who is funding our elections. \\n\\nTonight, I’d like to honor someone who has dedicated his life to serve this country: Justice Stephen Breyer—an Army veteran, Constitutional scholar, and retiring Justice of the United States Supreme Court. Justice Breyer, thank you for your service. \\n\\nOne of the most serious constitutional responsibilities a President has is nominating someone to serve on the United States Supreme Court. \\n\\nAnd I did that 4 days ago, when I nominated Circuit Court of Appeals Judge Ketanji Brown Jackson. One of our nation’s top legal minds, who will continue Justice Breyer’s legacy of excellence.', metadata={'source': '../../../../../docs/docs/modules/state_of_the_union.txt'}), Document(page_content='One was stationed at bases and breathing in toxic smoke from “burn pits” that incinerated wastes of war—medical and hazard material, jet fuel, and more. \\n\\nWhen they came home, many of the world’s fittest and best trained warriors were never the same. \\n\\nHeadaches. Numbness. Dizziness. \\n\\nA cancer that would put them in a flag-draped coffin. \\n\\nI know. \\n\\nOne of those soldiers was my son Major Beau Biden. \\n\\nWe don’t know for sure if a burn pit was the cause of his brain cancer, or the diseases of so many of our troops. \\n\\nBut I’m committed to finding out everything we can. \\n\\nCommitted to military families like Danielle Robinson from Ohio. \\n\\nThe widow of Sergeant First Class Heath Robinson.  \\n\\nHe was born a soldier. Army National Guard. Combat medic in Kosovo and Iraq. \\n\\nStationed near Baghdad, just yards from burn pits the size of football fields. \\n\\nHeath’s widow Danielle is here with us tonight. They loved going to Ohio State football games. He loved building Legos with their daughter.', metadata={'source': '../../../../../docs/docs/modules/state_of_the_union.txt'}), Document(page_content='A former top litigator in private practice. A former federal public defender. And from a family of public school educators and police officers. A consensus builder. Since she’s been nominated, she’s received a broad range of support—from the Fraternal Order of Police to former judges appointed by Democrats and Republicans. \\n\\nAnd if we are to advance liberty and justice, we need to secure the Border and fix the immigration system. \\n\\nWe can do both. At our border, we’ve installed new technology like cutting-edge scanners to better detect drug smuggling.  \\n\\nWe’ve set up joint patrols with Mexico and Guatemala to catch more human traffickers.  \\n\\nWe’re putting in place dedicated immigration judges so families fleeing persecution and violence can have their cases heard faster. \\n\\nWe’re securing commitments and supporting partners in South and Central America to host more refugees and secure their own borders.', metadata={'source': '../../../../../docs/docs/modules/state_of_the_union.txt'}), Document(page_content='We can’t change how divided we’ve been. But we can change how we move forward—on COVID-19 and other issues we must face together. \\n\\nI recently visited the New York City Police Department days after the funerals of Officer Wilbert Mora and his partner, Officer Jason Rivera. \\n\\nThey were responding to a 9-1-1 call when a man shot and killed them with a stolen gun. \\n\\nOfficer Mora was 27 years old. \\n\\nOfficer Rivera was 22. \\n\\nBoth Dominican Americans who’d grown up on the same streets they later chose to patrol as police officers. \\n\\nI spoke with their families and told them that we are forever in debt for their sacrifice, and we will carry on their mission to restore the trust and safety every community deserves. \\n\\nI’ve worked on these issues a long time. \\n\\nI know what works: Investing in crime prevention and community police officers who’ll walk the beat, who’ll know the neighborhood, and who can restore trust and safety.', metadata={'source': '../../../../../docs/docs/modules/state_of_the_union.txt'})]In the most recent state of the union, the President mentioned Kentaji Brown Jackson. The President nominated Circuit Court of Appeals Judge Ketanji Brown Jackson to serve on the United States Supreme Court. The President described Judge Ketanji Brown Jackson as one of our nation's top legal minds who will continue Justice Breyer's legacy of excellence.\n    \n    > Finished chain.\n\nresult[\"output\"]\n\n    \"In the most recent state of the union, the President mentioned Kentaji Brown Jackson. The President nominated Circuit Court of Appeals Judge Ketanji Brown Jackson to serve on the United States Supreme Court. The President described Judge Ketanji Brown Jackson as one of our nation's top legal minds who will continue Justice Breyer's legacy of excellence.\"\n\n\nNotice that the follow up question asks about information previously retrieved, so no need to do another retrieval\n\nresult = agent_executor({\"input\": \"how long ago did he nominate her?\"})\n\n    \n    \n    > Entering new AgentExecutor chain...\n    The President nominated Judge Ketanji Brown Jackson four days ago.\n    \n    > Finished chain.\n\nresult[\"output\"]\n\n    'The President nominated Judge Ketanji Brown Jackson four days ago.'\n\nCreating from components​\n\nWhat actually is going on underneath the hood? Let's take a look so we can understand how to modify going forward.\n\nThere are a few components:\n\nThe memory\nThe prompt template\nThe agent\nThe agent executor\n# This is needed for both the memory and the prompt\nmemory_key = \"history\"\n\nThe Memory​\n\nIn this example, we want the agent to remember not only previous conversations, but also previous intermediate steps. For that, we can use AgentTokenBufferMemory. Note that if you want to change whether the agent remembers intermediate steps, or how the long the buffer is, or anything like that you should change this part.\n\nfrom langchain.agents.openai_functions_agent.agent_token_buffer_memory import (\n    AgentTokenBufferMemory,\n)\n\nmemory = AgentTokenBufferMemory(memory_key=memory_key, llm=llm)\n\nThe Prompt Template​\n\nFor the prompt template, we will use the OpenAIFunctionsAgent default way of creating one, but pass in a system prompt and a placeholder for memory.\n\nfrom langchain.agents.openai_functions_agent.base import OpenAIFunctionsAgent\nfrom langchain.prompts import MessagesPlaceholder\nfrom langchain.schema.messages import SystemMessage\n\nsystem_message = SystemMessage(\n    content=(\n        \"Do your best to answer the questions. \"\n        \"Feel free to use any tools available to look up \"\n        \"relevant information, only if necessary\"\n    )\n)\n\nprompt = OpenAIFunctionsAgent.create_prompt(\n    system_message=system_message,\n    extra_prompt_messages=[MessagesPlaceholder(variable_name=memory_key)],\n)\n\nThe Agent​\n\nWe will use the OpenAIFunctionsAgent\n\nagent = OpenAIFunctionsAgent(llm=llm, tools=tools, prompt=prompt)\n\nThe Agent Executor​\n\nImportantly, we pass in return_intermediate_steps=True since we are recording that with our memory object\n\nfrom langchain.agents import AgentExecutor\n\nagent_executor = AgentExecutor(\n    agent=agent,\n    tools=tools,\n    memory=memory,\n    verbose=True,\n    return_intermediate_steps=True,\n)\n\nresult = agent_executor({\"input\": \"hi, im bob\"})\n\n    \n    \n    > Entering new AgentExecutor chain...\n    Hello Bob! How can I assist you today?\n    \n    > Finished chain.\n\nresult = agent_executor({\"input\": \"whats my name\"})\n\n    \n    \n    > Entering new AgentExecutor chain...\n    Your name is Bob.\n    \n    > Finished chain.\n\nPrevious\nRAG over code\nNext\nText splitting by header"
}